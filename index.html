<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>PadiCare â€“ Deteksi Penyakit Daun Padi</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <style>
    html, body {
      margin: 0;
      padding: 0;
      height: 100%;
      background: linear-gradient(to bottom right, #d4f3dd, #e6f4ea);
      font-family: 'Segoe UI', sans-serif;
      color: #2c3e50;
      overflow-x: hidden;
    }
    #leaf-canvas {
      position: fixed;
      top: 0;
      left: 0;
      width: 100vw;
      height: 100vh;
      z-index: -1;
    }
    .section-card {
      border-radius: 16px;
      box-shadow: 0 4px 20px rgba(0,0,0,0.06);
      padding: 2rem;
      margin-bottom: 2rem;
      background-color: rgba(255, 255, 255, 0.94);
    }
    .drop-zone {
      border: 2px dashed #198754;
      padding: 2rem;
      text-align: center;
      border-radius: 12px;
      background-color: #eafaf1;
    }
    img.preview {
      max-width: 100%;
      height: auto;
      border-radius: 12px;
      border: 1px solid #dee2e6;
    }
    .prediction-card {
      border: 1px solid #dee2e6;
      border-radius: 12px;
      padding: 1rem 1.5rem;
      background-color: #fdfdfd;
      margin-bottom: 1rem;
      box-shadow: 0 2px 8px rgba(0,0,0,0.04);
    }
    .prediction-title {
      font-weight: 600;
      color: #198754;
    }
  </style>
</head>
<body>
<canvas id="leaf-canvas"></canvas>
<script>
  const canvas = document.getElementById("leaf-canvas");
  const leafCtx = canvas.getContext("2d");
  const leafImg = new Image();
  leafImg.src = "https://cdn.jsdelivr.net/gh/adamrisqi/assets@main/leaf1.png";

  let leaves = [];
  let mouseX = 0;
  let mouseY = 0;

  function resizeCanvas() {
    canvas.width = window.innerWidth;
    canvas.height = window.innerHeight;
  }
  window.addEventListener("resize", resizeCanvas);
  resizeCanvas();

  canvas.addEventListener("mousemove", e => {
    mouseX = e.clientX;
    mouseY = e.clientY;
  });

  class Leaf {
    constructor() {
      this.reset();
    }
    reset() {
      this.x = Math.random() * canvas.width;
      this.y = -Math.random() * canvas.height;
      this.size = 20 + Math.random() * 15;
      this.speed = 0.5 + Math.random() * 1.5;
      this.angle = Math.random() * 2 * Math.PI;
      this.spin = 0.002 + Math.random() * 0.01;
    }
    update() {
      const dx = this.x - mouseX;
      const dy = this.y - mouseY;
      const dist = Math.sqrt(dx * dx + dy * dy);
      if (dist < 100) {
        this.x += dx / dist;
        this.y += dy / dist;
      } else {
        this.y += this.speed;
        this.x += Math.sin(this.angle) * 0.5;
        this.angle += this.spin;
      }
      if (this.y > canvas.height + this.size) this.reset();
    }
    draw() {
      leafCtx.save();
      leafCtx.translate(this.x, this.y);
      leafCtx.rotate(this.angle);
      leafCtx.globalAlpha = 0.6;
      leafCtx.drawImage(leafImg, -this.size / 2, -this.size / 2, this.size, this.size);
      leafCtx.restore();
    }
  }

  for (let i = 0; i < 80; i++) {
    leaves.push(new Leaf());
  }

  function animate() {
    leafCtx.clearRect(0, 0, canvas.width, canvas.height);
    for (let leaf of leaves) {
      leaf.update();
      leaf.draw();
    }
    requestAnimationFrame(animate);
  }

  leafImg.onload = () => animate();
</script>
<div class="container py-5">
  <div class="text-center mb-5">
    <h1 class="text-success">ðŸŒ¾ PadiCare</h1>
    <p class="text-muted">Sistem Cerdas untuk Deteksi Penyakit Daun Padi</p>
  </div>

  <div class="section-card text-center">
    <h4 class="text-success">Start Detection</h4>
    <p>Mulai deteksi penyakit dengan mengunggah gambar daun padi.</p>
    <input id="imageInput" class="form-control mb-3" type="file" accept="image/*" required>
    <button onclick="submitImage()" class="btn btn-success px-5">Start Detection</button>
  </div>

  <div id="previewContainer" class="section-card text-center" style="display:none">
    <h4 class="text-primary">Hasil Deteksi</h4>
    <img id="previewImage" class="preview mb-3" />
    <div class="chart-toggle mb-3">
      <button class="btn btn-outline-success btn-sm me-2" onclick="showChart('bar', chartLabels, chartData)">Bar Chart</button>
      <button class="btn btn-outline-success btn-sm me-2" onclick="showChart('pie', chartLabels, chartData)">Pie Chart</button>
      <button class="btn btn-outline-dark btn-sm me-2" onclick="toggleJSON()">Raw JSON</button>
      <button class="btn btn-outline-danger btn-sm" onclick="exportPDF()">Export to PDF</button>
    </div>
    <canvas id="chartCanvas" width="400" height="300" class="mb-4"></canvas>
    <div id="jsonView" class="bg-light p-3 rounded" style="display: none;">
      <pre id="jsonContent" style="white-space: pre-wrap; font-size: 0.9rem;"></pre>
    </div>
    <div id="results"></div>
  </div>
</div>

<script>
let chart;
let chartLabels = [];
let chartData = [];

async function submitImage() {
  const fileInput = document.getElementById('imageInput');
  const file = fileInput.files[0];
  if (!file) return alert("Pilih gambar terlebih dahulu.");

  const formData = new FormData();
  formData.append("file", file);

  const res = await fetch("https://yolo-backend-production.up.railway.app/predict", {
    method: "POST",
    body: formData
  });

  const data = await res.json();
  document.getElementById('previewImage').src = URL.createObjectURL(file);
  document.getElementById('previewContainer').style.display = 'block';

  const resultDiv = document.getElementById('results');
  resultDiv.innerHTML = '';

  const labels = [];
  const confidences = [];

  if (data.predictions && data.predictions.length > 0) {
    data.predictions.forEach(pred => {
      labels.push(pred.class.replace('_', ' '));
      confidences.push((pred.confidence * 100).toFixed(2));
      const card = document.createElement('div');
      card.className = 'prediction-card';
      card.innerHTML = `
        <div class="prediction-title">${pred.class.replace('_', ' ')}</div>
        <div><strong>Confidence:</strong> ${(pred.confidence * 100).toFixed(2)}%</div>
      `;
      resultDiv.appendChild(card);
    });
    chartLabels = labels;
    chartData = confidences;
    showChart('bar', labels, confidences);
  } else {
    resultDiv.innerHTML = '<p class="text-danger">Tidak ada penyakit terdeteksi.</p>';
  }
  document.getElementById("jsonContent").textContent = JSON.stringify(data, null, 2);
}

function showChart(type, labels, confidences) {
  const ctx = document.getElementById('chartCanvas').getContext('2d');
  if (chart) chart.destroy();
  chart = new Chart(ctx, {
    type: type,
    data: {
      labels: labels,
      datasets: [{
        label: 'Confidence %',
        data: confidences,
        backgroundColor: type === 'bar' ? 'rgba(40, 167, 69, 0.6)' : [
          'rgba(40, 167, 69, 0.6)',
          'rgba(33, 136, 56, 0.6)',
          'rgba(25, 100, 40, 0.6)'
        ],
        borderColor: 'rgba(40, 167, 69, 1)',
        borderWidth: 1
      }]
    },
    options: {
      responsive: true,
      plugins: {
        legend: { display: type === 'pie' }
      },
      scales: type === 'bar' ? {
        y: {
          beginAtZero: true,
          max: 100
        }
      } : {}
    }
  });
}

function toggleJSON() {
  const jsonDiv = document.getElementById('jsonView');
  jsonDiv.style.display = jsonDiv.style.display === 'none' ? 'block' : 'none';
}

function exportPDF() {
  import('https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js').then(jsPDF => {
    const { jsPDF: JSPDF } = jsPDF;
    const doc = new JSPDF();
    doc.text("Hasil Prediksi Daun Padi", 10, 10);
    chart.data.labels.forEach((label, i) => {
      doc.text(`${label}: ${chart.data.datasets[0].data[i]}%`, 10, 20 + i * 10);
    });
    doc.save("hasil-prediksi.pdf");
  });
}
</script>
</body>
</html>